<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Multiplication Table (20x20)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .control-group label {
            font-size: 1.2em;
            font-weight: bold;
            color: #555;
        }

        select {
            padding: 12px 20px;
            font-size: 1.2em;
            border: 3px solid #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        select:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .multiplication-display {
            text-align: center;
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border-radius: 15px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .table-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            overflow-x: auto;
        }

        .multiplication-table {
            border-collapse: collapse;
            border: 3px solid #333;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            font-size: 0.8em;
        }

        .table-cell {
            width: 45px;
            height: 45px;
            text-align: center;
            font-size: 0.9em;
            font-weight: bold;
            border: 1px solid #333;
            position: relative;
            transition: all 0.3s ease;
        }

        /* Theme Styles */
        .theme-rainbow .table-cell {
            background: var(--cell-bg, #f0f0f0);
        }

        .theme-balerina .table-cell {
            background: var(--cell-bg, #f0f0f0);
        }

        .theme-capucina .table-cell {
            background: var(--cell-bg, #f0f0f0);
        }

        .theme-princess .table-cell {
            background: var(--cell-bg, #f0f0f0);
        }

        .theme-unicorn .table-cell {
            background: var(--cell-bg, #f0f0f0);
        }

        .theme-butterfly .table-cell {
            background: var(--cell-bg, #f0f0f0);
        }

        .theme-ocean .table-cell {
            background: var(--cell-bg, #f0f0f0);
        }

        .theme-forest .table-cell {
            background: var(--cell-bg, #f0f0f0);
        }

        .theme-space .table-cell {
            background: var(--cell-bg, #f0f0f0);
        }

        .theme-candy .table-cell {
            background: var(--cell-bg, #f0f0f0);
        }

        .header-cell {
            background: linear-gradient(45deg, #2c3e50, #34495e);
            color: white;
            font-size: 1em;
            font-weight: 900;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            border: 2px solid #1a252f;
        }

        .x-cell {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            font-size: 1.2em;
            color: white;
            font-weight: 900;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            border: 2px solid #a93226;
        }

        .highlighted-row {
            background: linear-gradient(90deg, rgba(255, 107, 107, 0.4), rgba(255, 107, 107, 0.2)) !important;
            border-left: 4px solid #ff6b6b !important;
            border-right: 4px solid #ff6b6b !important;
        }

        .highlighted-col {
            background: linear-gradient(0deg, rgba(78, 205, 196, 0.4), rgba(78, 205, 196, 0.2)) !important;
            border-top: 4px solid #4ecdc4 !important;
            border-bottom: 4px solid #4ecdc4 !important;
        }

        .answer-cell {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4) !important;
            color: white !important;
            border: 4px solid #333 !important;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
            transform: scale(1.15);
            z-index: 10;
            font-size: 1.1em;
            font-weight: 900;
        }

        .arrow {
            position: absolute;
            font-size: 1.2em;
            color: #ff6b6b;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            z-index: 5;
        }

        .arrow-right {
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .arrow-down {
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
        }

        .arrow-diagonal {
            bottom: -10px;
            right: -10px;
            font-size: 1em;
        }

        .history-section {
            margin-top: 30px;
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #dee2e6;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .history-header h3 {
            margin: 0;
            color: #495057;
            font-size: 1.3em;
        }

        .history-toggle {
            font-size: 1.5em;
            transition: transform 0.3s ease;
        }

        .history-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .history-content.expanded {
            max-height: 500px;
        }

        .history-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .history-item {
            background: white;
            margin: 5px 0;
            padding: 10px 15px;
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:hover {
            background: #f8f9fa;
            transform: translateX(5px);
            transition: all 0.2s ease;
        }

        .clear-history {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .clear-history:hover {
            background: #c82333;
        }

        .tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .tooltip.show {
            opacity: 1;
        }

        .instructions {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(45deg, #f093fb, #f5576c);
            border-radius: 15px;
            color: white;
            font-size: 1.1em;
            line-height: 1.6;
        }

        .instructions h3 {
            margin-top: 0;
            font-size: 1.3em;
        }

        .support-section {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
        }

        .support-section p {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .support-link {
            display: inline-block;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            text-decoration: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1em;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .support-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        /* Teacher Controls */
        .teacher-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .teacher-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .print-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .print-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .export-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .print-bw-btn {
            background: linear-gradient(45deg, #757575, #616161);
            color: white;
        }

        .print-bw-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* Print Styles */
        @media print {
            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            .container {
                box-shadow: none !important;
                border-radius: 0 !important;
                padding: 10px !important;
                max-width: none !important;
            }

            .controls, .teacher-controls, .history-section, .instructions, .support-section {
                display: none !important;
            }

            .multiplication-display {
                background: #f0f0f0 !important;
                color: #333 !important;
                text-shadow: none !important;
                margin: 10px 0 !important;
                padding: 15px !important;
                border: 2px solid #333 !important;
            }

            .table-container {
                margin: 0 !important;
                overflow: visible !important;
            }

            .multiplication-table {
                box-shadow: none !important;
                border: 2px solid #000 !important;
                page-break-inside: avoid;
            }

            .table-cell {
                border: 1px solid #000 !important;
                background: white !important;
                color: black !important;
                font-weight: bold !important;
            }

            .header-cell {
                background: #e0e0e0 !important;
                color: black !important;
                font-weight: bold !important;
                border: 2px solid #000 !important;
            }

            .x-cell {
                background: #d0d0d0 !important;
                color: black !important;
                font-weight: bold !important;
                border: 2px solid #000 !important;
            }

            .highlighted-row {
                background: #ffeb3b !important;
                border-left: 3px solid #ff9800 !important;
                border-right: 3px solid #ff9800 !important;
            }

            .highlighted-col {
                background: #e1f5fe !important;
                border-top: 3px solid #2196f3 !important;
                border-bottom: 3px solid #2196f3 !important;
            }

            .answer-cell {
                background: #ffcdd2 !important;
                border: 4px solid #f44336 !important;
                font-weight: bold !important;
                color: black !important;
            }

            .arrow {
                display: none !important;
            }

            h1 {
                color: black !important;
                text-shadow: none !important;
                margin-bottom: 20px !important;
            }
        }

        /* Black and White Print Styles */
        .print-bw .table-cell {
            background: white !important;
            color: black !important;
        }

        .print-bw .header-cell {
            background: #f0f0f0 !important;
            color: black !important;
        }

        .print-bw .x-cell {
            background: #e0e0e0 !important;
            color: black !important;
        }

        .print-bw .highlighted-row {
            background: #f5f5f5 !important;
            border-left: 3px solid #333 !important;
            border-right: 3px solid #333 !important;
        }

        .print-bw .highlighted-col {
            background: #f8f8f8 !important;
            border-top: 3px solid #666 !important;
            border-bottom: 3px solid #666 !important;
        }

        .print-bw .answer-cell {
            background: #e8e8e8 !important;
            border: 4px solid #000 !important;
            font-weight: bold !important;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                gap: 20px;
            }
            
            .table-cell {
                width: 35px;
                height: 35px;
                font-size: 0.7em;
            }
            
            .header-cell {
                font-size: 0.8em;
            }

            .multiplication-table {
                font-size: 0.6em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Interactive Multiplication Table (20√ó20)</h1>
        
        <div class="controls">
            <div class="control-group" data-tooltip="Select the first number to multiply">
                <label for="first-number">First Number:</label>
                <select id="first-number">
                    <option value="">Choose...</option>
                </select>
            </div>
            
            <div class="control-group" data-tooltip="Select the second number to multiply">
                <label for="second-number">Second Number:</label>
                <select id="second-number">
                    <option value="">Choose...</option>
                </select>
            </div>

            <div class="control-group" data-tooltip="Choose your favorite theme!">
                <label for="theme-selector">Choose Theme:</label>
                <select id="theme-selector">
                    <option value="rainbow">üåà Rainbow</option>
                    <option value="balerina">ü©∞ Balerina</option>
                    <option value="capucina">üå∏ Capucina</option>
                    <option value="princess">üëë Princess</option>
                    <option value="unicorn">ü¶Ñ Unicorn</option>
                    <option value="butterfly">ü¶ã Butterfly</option>
                    <option value="ocean">üåä Ocean</option>
                    <option value="forest">üå≤ Forest</option>
                    <option value="space">üöÄ Space</option>
                    <option value="candy">üç≠ Candy</option>
                </select>
            </div>
        </div>

        <div class="teacher-controls">
            <button id="print-btn" class="teacher-btn print-btn">üñ®Ô∏è Print Table</button>
            <button id="export-png-btn" class="teacher-btn export-btn">üì∏ Export as PNG</button>
            <button id="print-bw-btn" class="teacher-btn print-bw-btn">‚ö´ Print B&W</button>
        </div>

        <div class="multiplication-display" id="multiplication-display">
            Select two numbers to see the multiplication!
        </div>

        <div class="table-container">
            <table class="multiplication-table" id="multiplication-table">
                <!-- Table will be generated by JavaScript -->
            </table>
        </div>

        <div class="history-section">
            <div class="history-header" id="history-header">
                <h3>üìö Calculation History</h3>
                <span class="history-toggle" id="history-toggle">‚ñº</span>
            </div>
            <div class="history-content" id="history-content">
                <ul class="history-list" id="history-list">
                    <!-- History items will be added here -->
                </ul>
                <button class="clear-history" id="clear-history">Clear History</button>
            </div>
        </div>

        <div class="instructions">
            <h3>üéì How to Use This Learning Tool</h3>
            <p><strong>Step 1:</strong> Choose your first number from the left dropdown (1-20)</p>
            <p><strong>Step 2:</strong> Choose your second number from the right dropdown (1-20)</p>
            <p><strong>Step 3:</strong> Watch the magic! The table will show you the path from both numbers to the answer</p>
            <p><strong>Step 4:</strong> The answer will be highlighted with a special border and arrows will guide you!</p>
            <p><strong>Step 5:</strong> Your calculations are automatically saved in the history section below</p>
            <p><strong>Step 6:</strong> Share your progress by copying the URL - it will remember your selections!</p>
        </div>

        <div class="support-section">
            <p>Enjoying this learning tool? Support the creator!</p>
            <a href="https://buymeacoffee.com/ashev" target="_blank" class="support-link">
                ‚òï Buy Me a Coffee
            </a>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Configuration
        const TABLE_SIZE = 20;
        const MAX_HISTORY_ITEMS = 50;

        // Generate dropdown options
        function generateDropdownOptions() {
            const firstSelect = document.getElementById('first-number');
            const secondSelect = document.getElementById('second-number');
            
            for (let i = 1; i <= TABLE_SIZE; i++) {
                const option1 = document.createElement('option');
                option1.value = i;
                option1.textContent = i;
                firstSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = i;
                option2.textContent = i;
                secondSelect.appendChild(option2);
            }
        }

        // Generate the multiplication table
        function generateTable() {
            const table = document.getElementById('multiplication-table');
            table.innerHTML = '';

            // Create header row
            const headerRow = document.createElement('tr');
            
            // Empty cell for top-left corner
            const xCell = document.createElement('td');
            xCell.className = 'table-cell x-cell';
            xCell.textContent = '√ó';
            headerRow.appendChild(xCell);

            // Column headers (1-20)
            for (let i = 1; i <= TABLE_SIZE; i++) {
                const cell = document.createElement('td');
                cell.className = 'table-cell header-cell';
                cell.textContent = i;
                cell.id = `col-${i}`;
                headerRow.appendChild(cell);
            }
            table.appendChild(headerRow);

            // Create data rows
            for (let i = 1; i <= TABLE_SIZE; i++) {
                const row = document.createElement('tr');
                
                // Row header
                const rowHeader = document.createElement('td');
                rowHeader.className = 'table-cell header-cell';
                rowHeader.textContent = i;
                rowHeader.id = `row-${i}`;
                row.appendChild(rowHeader);

                // Data cells
                for (let j = 1; j <= TABLE_SIZE; j++) {
                    const cell = document.createElement('td');
                    cell.className = 'table-cell';
                    cell.textContent = i * j;
                    cell.id = `cell-${i}-${j}`;
                    cell.style.background = getCellColor(i, j);
                    row.appendChild(cell);
                }
                table.appendChild(row);
            }
        }

        // Theme definitions
        const themes = {
            rainbow: {
                name: "üåà Rainbow",
                getCellColor: (row, col) => {
                    const value = row * col;
                    const maxValue = TABLE_SIZE * TABLE_SIZE;
                    const ratio = value / maxValue;
                    const hue = (ratio * 300) % 360;
                    const saturation = 70 + (ratio * 30);
                    const lightness = 60 + (ratio * 20);
                    return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
                }
            },
            balerina: {
                name: "ü©∞ Balerina",
                getCellColor: (row, col) => {
                    const value = row * col;
                    const maxValue = TABLE_SIZE * TABLE_SIZE;
                    const ratio = value / maxValue;
                    const colors = ['#ffb6c1', '#ffc0cb', '#ffd1dc', '#ffe4e1', '#f0e6ff', '#e6e6fa', '#f8f8ff', '#fff0f5', '#ffe4e6', '#ffb3ba'];
                    return colors[Math.floor(ratio * colors.length)];
                }
            },
            capucina: {
                name: "üå∏ Capucina",
                getCellColor: (row, col) => {
                    const value = row * col;
                    const maxValue = TABLE_SIZE * TABLE_SIZE;
                    const ratio = value / maxValue;
                    const colors = ['#ff9a9e', '#fecfef', '#fecfef', '#ffecd2', '#fcb69f', '#ff8a80', '#ffab91', '#ffccbc', '#f8bbd9', '#e1bee7'];
                    return colors[Math.floor(ratio * colors.length)];
                }
            },
            princess: {
                name: "üëë Princess",
                getCellColor: (row, col) => {
                    const value = row * col;
                    const maxValue = TABLE_SIZE * TABLE_SIZE;
                    const ratio = value / maxValue;
                    const colors = ['#ffd700', '#ffb347', '#ffa500', '#ff8c00', '#ff7f50', '#ff6347', '#ff69b4', '#ff1493', '#da70d6', '#ba55d3'];
                    return colors[Math.floor(ratio * colors.length)];
                }
            },
            unicorn: {
                name: "ü¶Ñ Unicorn",
                getCellColor: (row, col) => {
                    const value = row * col;
                    const maxValue = TABLE_SIZE * TABLE_SIZE;
                    const ratio = value / maxValue;
                    const colors = ['#e6e6fa', '#d8bfd8', '#dda0dd', '#ee82ee', '#da70d6', '#ba55d3', '#9370db', '#8a2be2', '#7b68ee', '#6a5acd'];
                    return colors[Math.floor(ratio * colors.length)];
                }
            },
            butterfly: {
                name: "ü¶ã Butterfly",
                getCellColor: (row, col) => {
                    const value = row * col;
                    const maxValue = TABLE_SIZE * TABLE_SIZE;
                    const ratio = value / maxValue;
                    const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43'];
                    return colors[Math.floor(ratio * colors.length)];
                }
            },
            ocean: {
                name: "üåä Ocean",
                getCellColor: (row, col) => {
                    const value = row * col;
                    const maxValue = TABLE_SIZE * TABLE_SIZE;
                    const ratio = value / maxValue;
                    const colors = ['#74b9ff', '#0984e3', '#00b894', '#00cec9', '#6c5ce7', '#a29bfe', '#fd79a8', '#e84393', '#fdcb6e', '#e17055'];
                    return colors[Math.floor(ratio * colors.length)];
                }
            },
            forest: {
                name: "üå≤ Forest",
                getCellColor: (row, col) => {
                    const value = row * col;
                    const maxValue = TABLE_SIZE * TABLE_SIZE;
                    const ratio = value / maxValue;
                    const colors = ['#a8e6cf', '#88d8a3', '#68c4a6', '#4a9b8e', '#2d7d77', '#1a5f5a', '#4a6741', '#6b8e23', '#8fbc8f', '#98fb98'];
                    return colors[Math.floor(ratio * colors.length)];
                }
            },
            space: {
                name: "üöÄ Space",
                getCellColor: (row, col) => {
                    const value = row * col;
                    const maxValue = TABLE_SIZE * TABLE_SIZE;
                    const ratio = value / maxValue;
                    const colors = ['#1e3c72', '#2a5298', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#c084fc', '#d946ef', '#ec4899', '#f43f5e'];
                    return colors[Math.floor(ratio * colors.length)];
                }
            },
            candy: {
                name: "üç≠ Candy",
                getCellColor: (row, col) => {
                    const value = row * col;
                    const maxValue = TABLE_SIZE * TABLE_SIZE;
                    const ratio = value / maxValue;
                    const colors = ['#ff6b9d', '#c44569', '#f8b500', '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43', '#ff6348', '#ff3838'];
                    return colors[Math.floor(ratio * colors.length)];
                }
            }
        };

        let currentTheme = 'rainbow';

        // Generate colors for cells based on current theme
        function getCellColor(row, col) {
            return themes[currentTheme].getCellColor(row, col);
        }

        // Clear all highlights
        function clearHighlights() {
            // Clear row highlights
            for (let i = 1; i <= TABLE_SIZE; i++) {
                const rowCells = document.querySelectorAll(`[id^="cell-${i}-"]`);
                rowCells.forEach(cell => {
                    cell.classList.remove('highlighted-row');
                });
            }

            // Clear column highlights
            for (let j = 1; j <= TABLE_SIZE; j++) {
                const colCells = document.querySelectorAll(`[id*="-${j}"]`);
                colCells.forEach(cell => {
                    cell.classList.remove('highlighted-col');
                });
            }

            // Clear answer highlight
            const answerCells = document.querySelectorAll('.answer-cell');
            answerCells.forEach(cell => {
                cell.classList.remove('answer-cell');
            });

            // Remove arrows
            const arrows = document.querySelectorAll('.arrow');
            arrows.forEach(arrow => arrow.remove());
        }

        // Add visual arrows
        function addArrows(firstNum, secondNum, answer) {
            // Arrow from row header to answer
            const rowHeader = document.getElementById(`row-${firstNum}`);
            const answerCell = document.getElementById(`cell-${firstNum}-${secondNum}`);
            
            if (rowHeader && answerCell) {
                const arrowRight = document.createElement('div');
                arrowRight.className = 'arrow arrow-right';
                arrowRight.textContent = '‚Üí';
                rowHeader.appendChild(arrowRight);
            }

            // Arrow from column header to answer
            const colHeader = document.getElementById(`col-${secondNum}`);
            
            if (colHeader && answerCell) {
                const arrowDown = document.createElement('div');
                arrowDown.className = 'arrow arrow-down';
                arrowDown.textContent = '‚Üì';
                colHeader.appendChild(arrowDown);
            }
        }

        // Add to history
        function addToHistory(firstNum, secondNum, answer) {
            const historyList = document.getElementById('history-list');
            const historyItem = document.createElement('li');
            historyItem.className = 'history-item';
            
            const calculation = document.createElement('span');
            calculation.textContent = `${firstNum} √ó ${secondNum} = ${answer}`;
            
            const timestamp = document.createElement('span');
            timestamp.textContent = new Date().toLocaleTimeString();
            timestamp.style.fontSize = '0.8em';
            timestamp.style.color = '#666';
            
            historyItem.appendChild(calculation);
            historyItem.appendChild(timestamp);
            
            // Add to beginning of list
            historyList.insertBefore(historyItem, historyList.firstChild);
            
            // Limit history size
            const items = historyList.querySelectorAll('.history-item');
            if (items.length > MAX_HISTORY_ITEMS) {
                historyList.removeChild(items[items.length - 1]);
            }
        }

        // Highlight the multiplication path
        function highlightMultiplication(firstNum, secondNum) {
            clearHighlights();

            if (!firstNum || !secondNum) return;

            const answer = firstNum * secondNum;

            // Update display
            const display = document.getElementById('multiplication-display');
            display.textContent = `${firstNum} √ó ${secondNum} = ${answer}`;

            // Add to history
            addToHistory(firstNum, secondNum, answer);

            // Highlight the row
            for (let j = 1; j <= TABLE_SIZE; j++) {
                const cell = document.getElementById(`cell-${firstNum}-${j}`);
                if (cell) {
                    cell.classList.add('highlighted-row');
                }
            }

            // Highlight the column
            for (let i = 1; i <= TABLE_SIZE; i++) {
                const cell = document.getElementById(`cell-${i}-${secondNum}`);
                if (cell) {
                    cell.classList.add('highlighted-col');
                }
            }

            // Highlight the answer cell
            const answerCell = document.getElementById(`cell-${firstNum}-${secondNum}`);
            if (answerCell) {
                answerCell.classList.add('answer-cell');
            }

            // Add arrows
            addArrows(firstNum, secondNum, answer);

            // Update URL
            updateURL(firstNum, secondNum);
        }

        // Update URL parameters
        function updateURL(firstNum, secondNum) {
            const url = new URL(window.location);
            if (firstNum && secondNum) {
                url.searchParams.set('a', firstNum);
                url.searchParams.set('b', secondNum);
            } else {
                url.searchParams.delete('a');
                url.searchParams.delete('b');
            }
            window.history.replaceState({}, '', url);
        }


        // Tooltip functionality
        function initTooltips() {
            const tooltip = document.getElementById('tooltip');
            const tooltipElements = document.querySelectorAll('[data-tooltip]');
            
            tooltipElements.forEach(element => {
                element.addEventListener('mouseenter', (e) => {
                    tooltip.textContent = e.target.getAttribute('data-tooltip');
                    tooltip.classList.add('show');
                });
                
                element.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('show');
                });
                
                element.addEventListener('mousemove', (e) => {
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY - 10 + 'px';
                });
            });
        }

        // History section functionality
        function initHistory() {
            const historyHeader = document.getElementById('history-header');
            const historyContent = document.getElementById('history-content');
            const historyToggle = document.getElementById('history-toggle');
            const clearHistoryBtn = document.getElementById('clear-history');
            
            historyHeader.addEventListener('click', () => {
                historyContent.classList.toggle('expanded');
                historyToggle.textContent = historyContent.classList.contains('expanded') ? '‚ñ≤' : '‚ñº';
            });
            
            clearHistoryBtn.addEventListener('click', () => {
                document.getElementById('history-list').innerHTML = '';
            });
        }

        // Theme switching functionality
        function switchTheme(themeName) {
            currentTheme = themeName;
            document.body.className = `theme-${themeName}`;
            
            // Regenerate table with new theme colors
            generateTable();
            
            // Re-highlight current selection if any
            const firstNum = parseInt(document.getElementById('first-number').value);
            const secondNum = parseInt(document.getElementById('second-number').value);
            if (firstNum && secondNum) {
                highlightMultiplication(firstNum, secondNum);
            }
        }

        // Event listeners
        document.getElementById('first-number').addEventListener('change', function() {
            const firstNum = parseInt(this.value);
            const secondNum = parseInt(document.getElementById('second-number').value);
            highlightMultiplication(firstNum, secondNum);
        });

        document.getElementById('second-number').addEventListener('change', function() {
            const firstNum = parseInt(document.getElementById('first-number').value);
            const secondNum = parseInt(this.value);
            highlightMultiplication(firstNum, secondNum);
        });

        document.getElementById('theme-selector').addEventListener('change', function() {
            switchTheme(this.value);
        });

        // Teacher functionality
        function initTeacherControls() {
            // Print functionality
            document.getElementById('print-btn').addEventListener('click', function() {
                window.print();
            });

            // PNG Export functionality
            document.getElementById('export-png-btn').addEventListener('click', function() {
                const table = document.getElementById('multiplication-table');
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set canvas size
                const rect = table.getBoundingClientRect();
                canvas.width = rect.width * 2; // Higher resolution
                canvas.height = rect.height * 2;
                
                // Scale context for higher resolution
                ctx.scale(2, 2);
                
                // Use html2canvas-like approach
                html2canvas(table, {
                    canvas: canvas,
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `multiplication-table-${currentTheme}-${new Date().toISOString().split('T')[0]}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                }).catch(err => {
                    // Fallback: simple canvas approach
                    const img = new Image();
                    img.onload = function() {
                        ctx.drawImage(img, 0, 0);
                        const link = document.createElement('a');
                        link.download = `multiplication-table-${currentTheme}-${new Date().toISOString().split('T')[0]}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    };
                    img.src = 'data:image/svg+xml;base64,' + btoa(`
                        <svg xmlns="http://www.w3.org/2000/svg" width="${rect.width}" height="${rect.height}">
                            <foreignObject width="100%" height="100%">
                                <div xmlns="http://www.w3.org/1999/xhtml">${table.outerHTML}</div>
                            </foreignObject>
                        </svg>
                    `);
                });
            });

            // Black and White Print functionality
            document.getElementById('print-bw-btn').addEventListener('click', function() {
                document.body.classList.add('print-bw');
                setTimeout(() => {
                    window.print();
                    setTimeout(() => {
                        document.body.classList.remove('print-bw');
                    }, 1000);
                }, 100);
            });
        }

        // Enhanced URL parameter loading
        function loadURLParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const firstNum = urlParams.get('a');
            const secondNum = urlParams.get('b');
            const theme = urlParams.get('theme');
            
            // Load theme first
            if (theme && themes[theme]) {
                document.getElementById('theme-selector').value = theme;
                switchTheme(theme);
            }
            
            // Load selections
            if (firstNum && secondNum) {
                document.getElementById('first-number').value = firstNum;
                document.getElementById('second-number').value = secondNum;
                highlightMultiplication(parseInt(firstNum), parseInt(secondNum));
            }
        }

        // Enhanced URL parameter updating
        function updateURL(firstNum, secondNum) {
            const url = new URL(window.location);
            if (firstNum && secondNum) {
                url.searchParams.set('a', firstNum);
                url.searchParams.set('b', secondNum);
            } else {
                url.searchParams.delete('a');
                url.searchParams.delete('b');
            }
            url.searchParams.set('theme', currentTheme);
            window.history.replaceState({}, '', url);
        }

        // Initialize everything when page loads
        window.addEventListener('load', function() {
            generateDropdownOptions();
            generateTable();
            initTooltips();
            initHistory();
            initTeacherControls();
            loadURLParameters();
            
            // Set default theme
            switchTheme('rainbow');
        });
    </script>
</body>
</html>
